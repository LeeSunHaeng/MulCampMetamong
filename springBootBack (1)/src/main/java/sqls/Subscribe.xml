<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="mul.camp.a.dao.SubscribeDao">

<!-- #21# 구독 회원정보 가져오기 -->
<select id="getSubInfo" parameterType="String" resultType="mul.camp.a.dto.SubscribeDto">
	<!-- SELECT SUB_ID, SUB_TYPE, SUB_PERIOD, TO_CHAR(SUB_STARTDAY, 'YYYYMMDD')
	FROM MATA_SUBSCRIBE
	WHERE SUB_ID=#{id} -->
	SELECT *
	FROM MATA_SUBSCRIBE
	WHERE SUB_ID=#{id}
</select>


<!-- #21# 구독 신청 -->
<!-- 1) 구독회원 DB 내 추가 _! 만료일자를 제외한 컬럼 추가 -->
<insert id="subAdd" parameterType="mul.camp.a.dto.SubscribeDto">
	INSERT INTO MATA_SUBSCRIBE(SUB_ID, SUB_TYPE, SUB_PERIOD, SUB_STARTDAY, SUB_MORNING, SUB_LUNCH, SUB_DINNER, SUB_SNACK)
	VALUES(#{subId}, #{subType}, #{subPeriod}, SYSDATE, #{subMorning}, #{subLunch}, #{subDinner}, #{subSnack})
</insert>

<!-- 1-1) 구독회원 DB 내 구독만료 일자 추가 -->
<!--      ! ADD_MONTHS 사용 시 매월 마지막 일수가 다른 달(2월 28일, 짝수/홀수달 ..)은 그달의 마지막일을 리턴받는다. -->
<update id="subAddEndday" parameterType="mul.camp.a.dto.SubscribeDto">
	UPDATE MATA_SUBSCRIBE
	SET SUB_ENDDAY=TO_CHAR(ADD_MONTHS(SYSDATE, +SUB_PERIOD), 'YYYYMMDD')
	WHERE SUB_ID=#{subId}
</update>

<!-- 2) 멤버 DB 내 구독값 1로 수정 -->
<update id="subUpdateMember" parameterType="mul.camp.a.dto.SubscribeDto">
	UPDATE META_MEMBER
	SET SUBSCRIBE=1
	WHERE ID=#{subId}
</update>


<!-- #21# 구독 만료확인 및 만료 시 멤버DB 내 구독값 변경 -->
<!-- 1) 구독 만료확인 -->
<select id="subEnddayCheck" parameterType="mul.camp.a.dto.SubscribeDto" resultType="mul.camp.a.dto.SubscribeDto">
 	SELECT *
	FROM MATA_SUBSCRIBE
	WHERE SUB_ID=#{subId} AND SUB_ENDDAY > TO_CHAR(SYSDATE, 'YYYYMMDD')
</select>

<!-- 2) 멤버 DB 내 구독값 0으로 수정 -->
<update id="subUpdateMemberEnd" parameterType="mul.camp.a.dto.SubscribeDto">
	UPDATE META_MEMBER
	SET SUBSCRIBE=0
	WHERE ID=#{subId}
</update>

<!-- 2-1) 구독 DB 내 해당 사용자 삭제 -->
<delete id="subDeleteUser" parameterType="mul.camp.a.dto.SubscribeDto">
	DELETE FROM MATA_SUBSCRIBE
	WHERE SUB_ID=#{subId}
</delete>


<!-- #21# 오늘의 다이어트 식단 랜덤 1개 select -->
<!-- 1) 다이어트 식단 -->
<!--    부등호 기호 사용을 위하여 <![CDATA[로 감싸줬음 -->
<select id="subRandomDietMeal" parameterType="mul.camp.a.dto.SubDietMealDto" resultType="mul.camp.a.dto.SubDietMealDto">
	SELECT *
	FROM (SELECT * FROM META_SUBSCRIBE_DIETMEALS WHERE SUBDF_TIME=#{subdfTime} ORDER BY DBMS_RANDOM.VALUE)
	<![CDATA[WHERE ROWNUM <= 1 AND SUBDF_KCAL <= #{subdfKcal}]]>	
</select>
<!-- 2) 운동 식단 -->
<select id="subRandomExerMeal" parameterType="mul.camp.a.dto.SubExerMealDto" resultType="mul.camp.a.dto.SubExerMealDto">
	SELECT *
	FROM (SELECT * FROM META_SUBSCRIBE_EXERMEALS WHERE SUBEF_TIME=#{subefTime} ORDER BY DBMS_RANDOM.VALUE)
	<![CDATA[WHERE ROWNUM <= 1 AND SUBEF_KCAL <= #{subefKcal}]]>
</select>


</mapper>